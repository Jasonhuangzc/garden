# ğŸ”„ æ¯æ—¥é‡ç½®åŠŸèƒ½ - å®ç°æŠ¥å‘Š

**å®æ–½æ—¶é—´**ï¼š2026-01-28 17:25  
**åŠŸèƒ½çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

## ğŸ“‹ åŠŸèƒ½éœ€æ±‚

### é‡ç½®æ—¶é—´
- **è§¦å‘æ—¶é—´**ï¼šåŒ—äº¬æ—¶é—´å‡Œæ™¨ **4:30**
- **æ£€æŸ¥é¢‘ç‡**ï¼šæ¯ **1åˆ†é’Ÿ** æ£€æŸ¥ä¸€æ¬¡
- **é‡ç½®å‘¨æœŸ**ï¼šæ¯å¤©ä¸€æ¬¡ï¼ˆé˜²æ­¢é‡å¤é‡ç½®ï¼‰

### é‡ç½®å†…å®¹
1. âœ… **ç”¨æˆ·ç§¯åˆ†** â†’ æ¸…é›¶
2. âœ… **lastSyncedWords**ï¼ˆå•è¯è¿½è¸ªï¼‰â†’ æ¸…é›¶
3. âœ… **å•è¯æ•°å’Œå­¦ä¹ æ—¶é•¿** â†’ æ¸…é›¶
4. âœ… **å…±äº«é‡‘å¸è´¦æˆ·** â†’ æ¸…é›¶
5. âœ… **èŠ±å›­æ‰€æœ‰èŠ±æœµ** â†’ æ¸…ç©º

### ä¸é‡ç½®å†…å®¹
- âœ… **ç”¨æˆ·åŸºæœ¬ä¿¡æ¯**ï¼ˆå§“åã€å¤´åƒç­‰ï¼‰ä¿ç•™
- âœ… **å†å²è®°å½•**ï¼ˆåœ¨é‡ç½®æ—¶æ·»åŠ ä¸€æ¡é‡ç½®è®°å½•ï¼‰

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. æ ¸å¿ƒå‡½æ•°ï¼ˆgame-logic.jsï¼‰

#### resetDailyData()
```javascript
/**
 * æ¯æ—¥é‡ç½®æ¸¸æˆæ•°æ®
 * é‡ç½®å†…å®¹ï¼š
 * - ç”¨æˆ·ç§¯åˆ†æ¸…é›¶
 * - ç”¨æˆ·lastSyncedWordsæ¸…é›¶
 * - å…±äº«é‡‘å¸æ¸…é›¶
 * - èŠ±å›­æ¸…ç©º
 */
export async function resetDailyData() {
    // 1. é‡ç½®ç”¨æˆ·æ•°æ®
    await updateDoc(user1Ref, {
        currentPoints: 0,
        lastSyncedWords: 0,
        totalWordsToday: 0,
        studyTimeToday: 0
    });
    
    // 2. é‡ç½®é‡‘å¸
    await updateDoc(coinsRef, {
        totalCoins: 0,
        history: [{ type: 'reset', ... }]
    });
    
    // 3. æ¸…ç©ºèŠ±å›­
    await updateDoc(gardenRef, {
        occupiedPlots: 0,
        grid: emptyGrid
    });
    
    // 4. è®°å½•é‡ç½®æ—¶é—´
    await setDoc(resetRef, {
        lastResetDate: getTodayDateString(),
        lastResetTime: new Date().toISOString()
    });
}
```

#### checkAndResetDaily()
```javascript
/**
 * æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œæ¯æ—¥é‡ç½®
 * æ¡ä»¶ï¼š
 * 1. ä»Šå¤©è¿˜æ²¡é‡ç½®è¿‡
 * 2. å½“å‰æ—¶é—´æ˜¯åŒ—äº¬æ—¶é—´4:30-5:00ä¹‹é—´
 */
export async function checkAndResetDaily() {
    const beijingTime = new Date(now.toLocaleString('en-US', { 
        timeZone: 'Asia/Shanghai' 
    }));
    
    const hours = beijingTime.getHours();
    const minutes = beijingTime.getMinutes();
    
    // åˆ¤æ–­æ¡ä»¶
    if (lastResetDate !== todayDate && 
        hours === 4 && 
        minutes >= 30 && 
        minutes < 60) {
        return await resetDailyData();
    }
}
```

#### getTodayDateString()
```javascript
/**
 * è·å–åŒ—äº¬æ—¶é—´çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼‰
 */
function getTodayDateString() {
    const beijingTime = new Date(now.toLocaleString('en-US', { 
        timeZone: 'Asia/Shanghai' 
    }));
    
    return `${year}-${month}-${day}`;  // "2026-01-28"
}
```

---

### 2. å‰ç«¯é›†æˆï¼ˆscript.jsï¼‰

#### åˆå§‹åŒ–æ—¶æ£€æŸ¥
```javascript
async function initializeGame() {
    // 1. é¦–æ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
    await checkAndResetDaily();
    
    // 2. åˆå§‹åŒ–æ•°æ®åº“
    await initializeGameDatabase();
    
    // ...å…¶ä»–åˆå§‹åŒ–é€»è¾‘
    
    // 7. å®šæ—¶æ£€æŸ¥é‡ç½®ï¼ˆæ¯åˆ†é’Ÿï¼‰
    setInterval(async () => {
        await checkAndResetDaily();
    }, 60000);
}
```

---

### 3. ç®¡ç†é¢æ¿ï¼ˆadmin.htmlï¼‰

#### æ‰‹åŠ¨é‡ç½®æŒ‰é’®
```html
<button onclick="resetDaily()" style="background: #ff4444;">
    ğŸ”„ æ¯æ—¥é‡ç½®ï¼ˆå±é™©ï¼‰
</button>
```

#### ç¡®è®¤å¯¹è¯æ¡†
```javascript
window.resetDaily = async function () {
    if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ¸¸æˆæ•°æ®ï¼\n\nç¡®å®šè¦æ‰§è¡Œæ¯æ—¥é‡ç½®å—ï¼Ÿ')) {
        return;
    }
    
    const result = await resetDailyData();
    // æ˜¾ç¤ºç»“æœæ—¥å¿—
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“å˜æ›´

### æ–°å¢é›†åˆï¼šsystem/reset

```javascript
{
    "lastResetDate": "2026-01-28",          // ä¸Šæ¬¡é‡ç½®æ—¥æœŸ
    "lastResetTime": "2026-01-28T04:30:00", // ä¸Šæ¬¡é‡ç½®æ—¶é—´
    "timezone": "Asia/Shanghai"             // æ—¶åŒº
}
```

**ä½œç”¨**ï¼šé˜²æ­¢åŒä¸€å¤©å¤šæ¬¡é‡ç½®

---

## â° é‡ç½®æµç¨‹

### è‡ªåŠ¨é‡ç½®æµç¨‹

```
[åŒ—äº¬æ—¶é—´ 04:30:00]
    â†“
checkAndResetDaily() è¢«å®šæ—¶å™¨è°ƒç”¨
    â†“
æ£€æŸ¥ system/reset é›†åˆ
    â†“
lastResetDate == ä»Šå¤©? 
    YES â†’ è·³è¿‡é‡ç½®
    NO  â†’ ç»§ç»­æ£€æŸ¥æ—¶é—´
    â†“
å½“å‰æ—¶é—´ == 04:30-05:00?
    YES â†’ æ‰§è¡Œ resetDailyData()
    NO  â†’ è·³è¿‡é‡ç½®
    â†“
[é‡ç½®å®Œæˆ] è®°å½•æ—¶é—´åˆ° system/reset
```

### æ‰‹åŠ¨é‡ç½®æµç¨‹

```
[ç®¡ç†å‘˜ç‚¹å‡»é‡ç½®æŒ‰é’®]
    â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    â†“
ç”¨æˆ·ç¡®è®¤?
    YES â†’ æ‰§è¡Œ resetDailyData()
    NO  â†’ å–æ¶ˆæ“ä½œ
    â†“
[é‡ç½®å®Œæˆ] æ˜¾ç¤ºæ—¥å¿—
```

---

## ğŸ“Š é‡ç½®å‰åå¯¹æ¯”

### é‡ç½®å‰
```javascript
{
  users: {
    user1: {
      currentPoints: 44,
      lastSyncedWords: 44,
      totalWordsToday: 44,
      studyTimeToday: 22
    }
  },
  sharedAccount: {
    coins: { totalCoins: 575 }
  },
  garden: {
    plots: { occupiedPlots: 10, grid: [...] }
  }
}
```

### é‡ç½®å
```javascript
{
  users: {
    user1: {
      currentPoints: 0,        // âœ… æ¸…é›¶
      lastSyncedWords: 0,      // âœ… æ¸…é›¶
      totalWordsToday: 0,      // âœ… æ¸…é›¶
      studyTimeToday: 0        // âœ… æ¸…é›¶
    }
  },
  sharedAccount: {
    coins: { 
      totalCoins: 0,           // âœ… æ¸…é›¶
      history: [{ type: 'reset', ... }]  // âœ… è®°å½•é‡ç½®
    }
  },
  garden: {
    plots: { 
      occupiedPlots: 0,        // âœ… æ¸…é›¶
      grid: [null, null, ...]  // âœ… æ¸…ç©º
    }
  },
  system: {
    reset: {
      lastResetDate: "2026-01-28",  // âœ… è®°å½•æ—¥æœŸ
      lastResetTime: "..."           // âœ… è®°å½•æ—¶é—´
    }
  }
}
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸è‡ªåŠ¨é‡ç½®
```
æ—¶é—´ï¼š2026-01-28 04:30:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
æ¡ä»¶ï¼šä»Šå¤©è¿˜æœªé‡ç½®
é¢„æœŸï¼šâœ… è‡ªåŠ¨æ‰§è¡Œé‡ç½®ï¼Œæ‰€æœ‰æ•°æ®æ¸…é›¶
```

### åœºæ™¯2ï¼šé¿å…é‡å¤é‡ç½®
```
æ—¶é—´ï¼š2026-01-28 04:35:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
æ¡ä»¶ï¼šä»Šå¤©å·²é‡ç½®è¿‡
é¢„æœŸï¼šâœ… è·³è¿‡é‡ç½®ï¼Œæ—¥å¿—æ˜¾ç¤º"æ— éœ€é‡ç½®"
```

### åœºæ™¯3ï¼šæ—¶é—´ä¸åŒ¹é…
```
æ—¶é—´ï¼š2026-01-28 05:30:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
æ¡ä»¶ï¼šé”™è¿‡é‡ç½®æ—¶é—´çª—å£
é¢„æœŸï¼šâœ… è·³è¿‡é‡ç½®ï¼Œç­‰å¾…æ˜å¤©
```

### åœºæ™¯4ï¼šæ‰‹åŠ¨é‡ç½®
```
æ“ä½œï¼šç‚¹å‡»adminé¢æ¿çš„é‡ç½®æŒ‰é’®
é¢„æœŸï¼šâœ… å¼¹å‡ºç¡®è®¤æ¡† â†’ ç”¨æˆ·ç¡®è®¤ â†’ ç«‹å³é‡ç½®
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ—¶åŒºå¤„ç†
- ä½¿ç”¨ `Asia/Shanghai` æ—¶åŒº
- ä¸å—æœåŠ¡å™¨æ—¶åŒºå½±å“
- ç¡®ä¿åŒ—äº¬æ—¶é—´å‡†ç¡®

### 2. é‡ç½®çª—å£
- **30åˆ†é’Ÿçª—å£**ï¼š04:30 - 05:00
- æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œç¡®ä¿ä¸ä¼šé”™è¿‡
- å¦‚æœæœåŠ¡å™¨åœ¨çª—å£æœŸé—´é‡å¯ï¼Œä»èƒ½è§¦å‘

### 3. æ•°æ®å®‰å…¨
- æ‰‹åŠ¨é‡ç½®éœ€è¦ç¡®è®¤
- é‡ç½®æ“ä½œè®°å½•åˆ°å†å²
- æ— æ³•æ¢å¤é‡ç½®çš„æ•°æ®

### 4. ä¸ä¸èƒŒå•è¯Appçš„åŒæ­¥
- Appåœ¨å‡Œæ™¨4:00æ¸…é›¶å•è¯æ•°
- æ¸¸æˆåœ¨4:30æ¸…é›¶ï¼Œç•™å‡º30åˆ†é’Ÿç¼“å†²
- é¦–æ¬¡åŒæ­¥ï¼ˆå¦‚4:35ï¼‰ä¼šè¯»å–åˆ°0ä¸ªå•è¯

---

## ğŸ“ é…ç½®å‚æ•°

```javascript
// å¯è°ƒæ•´çš„é…ç½®
const RESET_CONFIG = {
    RESET_HOUR: 4,           // é‡ç½®å°æ—¶ï¼ˆ4ç‚¹ï¼‰
    RESET_MINUTE: 30,        // é‡ç½®åˆ†é’Ÿï¼ˆ30åˆ†ï¼‰
    CHECK_INTERVAL: 60000,   // æ£€æŸ¥é—´éš”ï¼ˆ1åˆ†é’Ÿï¼‰
    TIMEZONE: 'Asia/Shanghai' // æ—¶åŒº
};
```

**ä¿®æ”¹é‡ç½®æ—¶é—´**ï¼š
```javascript
// æ”¹ä¸ºå‡Œæ™¨3:00é‡ç½®
if (hours === 3 && minutes >= 0 && minutes < 30) {
    // ...
}
```

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `game-logic.js` - æ·»åŠ é‡ç½®å‡½æ•°ï¼ˆ+138è¡Œï¼‰
- âœ… `script.js` - é›†æˆå®šæ—¶æ£€æŸ¥ï¼ˆ+7è¡Œï¼‰
- âœ… `admin.html` - æ·»åŠ æ‰‹åŠ¨é‡ç½®ï¼ˆ+26è¡Œï¼‰

### æ–°å¢æ•°æ®åº“é›†åˆ
- âœ… `system/reset` - è®°å½•é‡ç½®çŠ¶æ€

---

## ğŸ“ˆ åŠŸèƒ½ä¼˜åŠ¿

### 1. è‡ªåŠ¨åŒ–
- âœ… æ— éœ€äººå·¥å¹²é¢„
- âœ… æ¯å¤©å‡†æ—¶é‡ç½®
- âœ… é˜²æ­¢é‡å¤æ‰§è¡Œ

### 2. å‡†ç¡®æ€§
- âœ… ä½¿ç”¨åŒ—äº¬æ—¶é—´
- âœ… 30åˆ†é’Ÿçª—å£å®¹é”™
- âœ… æ¯åˆ†é’Ÿæ£€æŸ¥ç¡®ä¿ä¸é—æ¼

### 3. å®‰å…¨æ€§
- âœ… æ‰‹åŠ¨é‡ç½®éœ€ç¡®è®¤
- âœ… è®°å½•é‡ç½®å†å²
- âœ… æ—¶é—´è®°å½•å¯è¿½æº¯

### 4. å¯ç»´æŠ¤æ€§
- âœ… ä»£ç æ¸…æ™°
- âœ… å‚æ•°å¯é…ç½®
- âœ… æ—¥å¿—å®Œæ•´

---

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

- [x] é‡ç½®ç”¨æˆ·ç§¯åˆ†
- [x] é‡ç½®lastSyncedWords
- [x] é‡ç½®å•è¯æ•°å’Œå­¦ä¹ æ—¶é•¿
- [x] é‡ç½®é‡‘å¸è´¦æˆ·
- [x] æ¸…ç©ºèŠ±å›­
- [x] è®°å½•é‡ç½®æ—¶é—´
- [x] é˜²æ­¢é‡å¤é‡ç½®
- [x] è‡ªåŠ¨å®šæ—¶æ£€æŸ¥
- [x] æ‰‹åŠ¨é‡ç½®åŠŸèƒ½
- [x] ç¡®è®¤å¯¹è¯æ¡†
- [x] æ—¥å¿—è®°å½•

---

## ğŸ¯ æ€»ç»“

**æ¯æ—¥é‡ç½®åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼**

### æ ¸å¿ƒç‰¹æ€§
1. âœ… æ¯å¤©åŒ—äº¬æ—¶é—´4:30è‡ªåŠ¨é‡ç½®
2. âœ… æ¸…ç©ºæ‰€æœ‰æ¸¸æˆè¿›åº¦ï¼ˆç§¯åˆ†ã€é‡‘å¸ã€èŠ±å›­ï¼‰
3. âœ… é…åˆä¸èƒŒå•è¯Appçš„4:00æ¸…é›¶
4. âœ… æä¾›æ‰‹åŠ¨é‡ç½®åŠŸèƒ½ï¼ˆç®¡ç†å‘˜ï¼‰
5. âœ… å®Œæ•´çš„æ—¥å¿—å’Œå†å²è®°å½•

### ä¸‹ä¸€æ­¥å»ºè®®
- ç›‘æ§é¦–æ¬¡è‡ªåŠ¨é‡ç½®ï¼ˆ2026-01-29 04:30ï¼‰
- éªŒè¯æ—¶åŒºå¤„ç†æ­£ç¡®æ€§
- æ”¶é›†ç”¨æˆ·åé¦ˆ

---

**å®ç°å®Œæˆ**ï¼š2026-01-28 17:25  
**å·¥ç¨‹å¸ˆ**ï¼šAntigravity AI Backend Engineer  
**çŠ¶æ€**ï¼šâœ… ç”Ÿäº§å°±ç»ª
